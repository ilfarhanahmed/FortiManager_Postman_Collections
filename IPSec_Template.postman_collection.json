{
  "info": {
    "_postman_id": "7891eb94-df57-4f90-b1ff-90ac46f33980",
    "name": "IPSec_Template",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "30322334"
  },
  "item": [
    {
      "name": "FMG_LOGIN",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "let responseData=pm.response.json();\r",
              "pm.collectionVariables.set(\"session\", responseData.session);"
            ],
            "type": "text/javascript",
            "packages": {}
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"id\": 1,\r\n    \"method\": \"exec\",\r\n    \"params\": [{\r\n        \"data\": {\r\n            \"user\": \"{{ADMIN}}\",\r\n            \"passwd\": \"{{PASSWORD}}\"\r\n        },\r\n        \"url\": \"/sys/login/user\"\r\n    }]\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "Create IPSec template",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"set\",\r\n    \"params\": [\r\n        {\r\n            \"data\": {\r\n                \"name\": \"{{TEMPLATE_NAME}}\",\r\n                \"template setting\": {\r\n                    \"stype\": \"_ipsec\",\r\n                    \"widgets\": [\r\n                        \"_ipsec\"\r\n                    ]\r\n                },\r\n                \"type\": \"template\"\r\n            },\r\n            \"url\": \"/pm/template/_ipsec/adom/{{ADOM}}/\"\r\n        }\r\n    ],\r\n    \"session\": \"{{session}}\",\r\n    \"id\": 1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "Add tunnels to IPSec template",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"set\",\r\n    \"params\": [\r\n        {\r\n            \"data\": {\r\n                \"dynamic_mapping\": null,\r\n                \"var-list\": null,\r\n                \"seq\": 1,\r\n                \"action\": \"conf-ipsec-template\",\r\n                \"model\": \"all\",\r\n                \"value\": {\r\n                    \"automatic-routing\": \"disable\",\r\n                    \"local-addr-type\": \"dynamic\",\r\n                    \"name\": \"{{TUNNEL_NAME}}\",\r\n                    \"nat\": \"disable\",\r\n                    \"remote-subnet\": [\r\n                        \"0.0.0.0/0.0.0.0\"\r\n                    ],\r\n                    \"system interface\": {\r\n                        \"ip\": \"{{TUNNEL_INTERFACE_IP}}\",\r\n                        \"remote-ip\": \"{{TUNNEL_REMOTE_IP}}\"\r\n                    }\r\n                }\r\n            },\r\n            \"url\": \"/pm/config/adom/{{ADOM}}/template/_ipsec/{{TEMPLATE_NAME}}/action-list/\"\r\n        }\r\n    ],\r\n    \"session\": \"{{session}}\",\r\n    \"id\": 1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "Add phase1 to tunnel",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"set\",\r\n    \"params\": [\r\n        {\r\n            \"data\": {\r\n                \"name\": \"{{TUNNEL_NAME}}\",\r\n                \"type\": 0,\r\n                \"interface\": [\r\n                    \"{{INTERFACE}}\"\r\n                ],\r\n                \"local-gw\": \"{{LOCAL_GW_IP}}\",\r\n                \"localid\": \"{{LOCAL_ID}}\",\r\n                \"dpd\": 3,\r\n                \"nattraversal\": 1,\r\n                \"dhgrp\": 12,\r\n                \"proposal\": [\r\n                    \"aes256-sha256\"\r\n                ],\r\n                \"keylife\": 86400,\r\n                \"authmethod\": 1,\r\n                \"peertype\": 1,\r\n                \"add-gw-route\": 0,\r\n                \"distance\": 15,\r\n                \"priority\": 1,\r\n                \"remote-gw\": \"{{REMOTE_GW_IP}}\",\r\n                \"psksecret\": [\r\n                    \"{{PSKSECRET}}\"\r\n                ]\r\n            },\r\n            \"url\": \"/pm/config/adom/{{ADOM}}/template/_ipsec/{{TEMPLATE_NAME}}/vpn/ipsec/phase1-interface/\"\r\n        }\r\n    ],\r\n    \"session\": \"{{session}}\",\r\n    \"id\": 1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "Add phase2 to tunnel",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer p44w9brsabyfug8kpidh7bygnxbg7j6o",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"set\",\r\n    \"params\": [\r\n        {\r\n            \"data\": {\r\n                \"name\": \"{{TUNNEL_NAME}}\",\r\n                \"phase1name\": [\r\n                    \"{{TUNNEL_NAME}}\"\r\n                ],\r\n                \"proposal\": [\r\n                    \"aes256-sha256\",\r\n                    \"3des-md5\"\r\n                ],\r\n                \"replay\": 1,\r\n                \"auto-negotiate\": 1,\r\n                \"src-subnet\": [\r\n                    \"0.0.0.0\",\r\n                    \"0.0.0.0\"\r\n                ],\r\n                \"src-addr-type\": 0,\r\n                \"src-port\": 0,\r\n                \"dst-addr-type\": 0,\r\n                \"dst-port\": 0,\r\n                \"keylifeseconds\": 43200,\r\n                \"dst-subnet\": [\r\n                    \"0.0.0.0\",\r\n                    \"0.0.0.0\"\r\n                ]\r\n            },\r\n            \"url\": \"/pm/config/adom/root/template/_ipsec/{{TEMPLATE_NAME}}/vpn/ipsec/phase2-interface/\"\r\n        }\r\n    ],\r\n    \"session\": \"{{session}}\",\r\n    \"id\": 1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "Assign Template to device",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"set\",\r\n    \"params\": [\r\n        {\r\n            \"data\": {\r\n                \"name\": \"{{DEVICE}}\",\r\n                \"vdom\": \"{{VDOM}}\"\r\n            },\r\n            \"url\": \"/pm/template/_ipsec/adom/{{ADOM}}/{{TEMPLATE_NAME}}/scope member\"\r\n        }\r\n    ],\r\n    \"session\": \"{{session}}\",\r\n    \"id\": 1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "GET Template",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.collectionVariables.set(\"templateResponse\", JSON.stringify(pm.response.json()));\r",
              ""
            ],
            "type": "text/javascript",
            "packages": {}
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"get\",\r\n    \"params\": [\r\n        {\r\n            \"url\": \"/pm/template/_ipsec/adom/{{ADOM}}/{{TEMPLATE_NAME}}\"\r\n        }\r\n    ],\r\n    \"id\": \"8\",\r\n    \"session\": \"{{session}}\",\r\n    \"verbose\":1\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    },
    {
      "name": "GET Template Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Get the saved template response from first request\r",
              "const templateResponseRaw = pm.collectionVariables.get(\"templateResponse\");\r",
              "const templateResponse = templateResponseRaw ? JSON.parse(templateResponseRaw) : null;\r",
              "\r",
              "const actionResponse = pm.response.json();\r",
              "const actionList = actionResponse.result?.[0]?.data || [];\r",
              "\r",
              "const templateData = templateResponse?.result?.[0]?.data || {};\r",
              "const scopeMembers = templateData[\"scope member\"] || [];\r",
              "const templateName = templateData.name || \"N/A\";\r",
              "const templateOid = templateData.oid || \"N/A\";\r",
              "\r",
              "// Prepare Scope Members rows for table\r",
              "let scopeRows = scopeMembers.length > 0 \r",
              "  ? scopeMembers.map((m, i) => `\r",
              "    <tr>\r",
              "        <td>${i + 1}</td>\r",
              "        <td>${m.name}</td>\r",
              "        <td>${m.vdom}</td>\r",
              "    </tr>\r",
              "  `).join(\"\")\r",
              "  : `<tr><td colspan=\"3\">No scope members found</td></tr>`;\r",
              "\r",
              "// Prepare VPN rows (action list items)\r",
              "let vpnRows = actionList.length > 0\r",
              "  ? actionList.map((item, i) => {\r",
              "      const val = item.value || {};\r",
              "      const phase1 = val[\"vpn ipsec phase1-interface\"] || {};\r",
              "      const phase2 = (val[\"vpn ipsec phase2-interface\"] || [])[0] || {};\r",
              "      const sysInterface = val[\"system interface\"] || {};\r",
              "      const tunnelInterfaceSetup = `${sysInterface.ip || \"N/A\"} ‚ûù ${sysInterface[\"remote-ip\"] || \"N/A\"}`;\r",
              "\r",
              "      // Format phase1 details for clarity\r",
              "      const phase1Info = `\r",
              "        <strong>Name:</strong> ${phase1.name || val.name || \"N/A\"}<br/>\r",
              "        <strong>Local GW:</strong> ${phase1[\"local-gw\"] || \"N/A\"}<br/>\r",
              "        <strong>Remote GW:</strong> ${phase1[\"remote-gw\"] || \"N/A\"}<br/>\r",
              "        <strong>Proposals:</strong> ${(phase1.proposal || []).join(\", \") || \"N/A\"}<br/>\r",
              "        <strong>Mode:</strong> ${phase1.mode || \"N/A\"}<br/>\r",
              "        <strong>Auth Method:</strong> ${phase1.authmethod || \"N/A\"}\r",
              "      `;\r",
              "\r",
              "      // Format phase2 details for clarity\r",
              "      const phase2Info = `\r",
              "        <strong>Name:</strong> ${phase2.name || \"N/A\"}<br/>\r",
              "        <strong>Dst Subnet:</strong> ${phase2[\"dst-subnet\"]?.join(\"/\") || \"N/A\"}<br/>\r",
              "        <strong>Src Subnet:</strong> ${phase2[\"src-subnet\"]?.join(\"/\") || \"N/A\"}<br/>\r",
              "        <strong>Proposals:</strong> ${(phase2.proposal || []).join(\", \") || \"N/A\"}<br/>\r",
              "        <strong>PFS:</strong> ${phase2.pfs || \"N/A\"}<br/>\r",
              "        <strong>Encapsulation:</strong> ${phase2.encapsulation || \"N/A\"}\r",
              "      `;\r",
              "\r",
              "      return `\r",
              "        <tr>\r",
              "          <td>${i + 1}</td>\r",
              "          <td>${val.name || \"N/A\"}</td>\r",
              "          <td>${phase1Info}</td>\r",
              "          <td>${phase2Info}</td>\r",
              "          <td>${tunnelInterfaceSetup}</td>\r",
              "        </tr>\r",
              "      `;\r",
              "  }).join(\"\")\r",
              "  : `<tr><td colspan=\"5\">No VPN action list data found</td></tr>`;\r",
              "\r",
              "// Final HTML output for Postman visualizer\r",
              "const html = `\r",
              "  <style>\r",
              "    table {\r",
              "      width: 100%;\r",
              "      border-collapse: collapse;\r",
              "      font-family: Arial, sans-serif;\r",
              "      margin-bottom: 24px;\r",
              "    }\r",
              "    th, td {\r",
              "      border: 1px solid #ccc;\r",
              "      padding: 8px;\r",
              "      vertical-align: top;\r",
              "      text-align: left;\r",
              "    }\r",
              "    th {\r",
              "      background-color: #f2f2f2;\r",
              "    }\r",
              "    h3 {\r",
              "      color: #333;\r",
              "      margin-top: 40px;\r",
              "      margin-bottom: 8px;\r",
              "    }\r",
              "  </style>\r",
              "\r",
              "  <h3>IPsec Template Info</h3>\r",
              "  <p><strong>Name:</strong> ${templateName}</p>\r",
              "\r",
              "  <h3>Scope Members</h3>\r",
              "  <table>\r",
              "    <thead>\r",
              "      <tr><th>#</th><th>Device Name</th><th>VDOM</th></tr>\r",
              "    </thead>\r",
              "    <tbody>\r",
              "      ${scopeRows}\r",
              "    </tbody>\r",
              "  </table>\r",
              "\r",
              "  <h3>VPN Details (Phase 1 & 2)</h3>\r",
              "  <table>\r",
              "    <thead>\r",
              "      <tr>\r",
              "        <th>#</th>\r",
              "        <th>VPN Name</th>\r",
              "        <th>Phase 1 Details</th>\r",
              "        <th>Phase 2 Details</th>\r",
              "        <th>Tunnel Interface Setup</th>\r",
              "      </tr>\r",
              "    </thead>\r",
              "    <tbody>\r",
              "      ${vpnRows}\r",
              "    </tbody>\r",
              "  </table>\r",
              "`;\r",
              "\r",
              "// Render HTML visualization in Postman\r",
              "pm.visualizer.set(html, {});"
            ],
            "type": "text/javascript",
            "packages": {}
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\r\n    \"method\": \"get\",\r\n    \"params\": [\r\n        {\r\n            \"url\": \"/pm/config/adom/root/template/_ipsec/{{TEMPLATE_NAME}}/action-list/\"\r\n        }\r\n    ],\r\n    \"id\": \"1\",\r\n    \"session\": \"{{session}}\",\r\n    \"verbose\": 1\r\n\r\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "https://{{host}}/jsonrpc",
          "protocol": "https",
          "host": [
            "{{host}}"
          ],
          "path": [
            "jsonrpc"
          ]
        }
      },
      "response": []
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "exec": [
          ""
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "exec": [
          ""
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "host",
      "value": "FMG IP address",
      "type": "string"
    },
    {
      "key": "ADMIN",
      "value": "FMG Admin User",
      "type": "string"
    },
    {
      "key": "PASSWORD",
      "value": "FMG Admin Password",
      "type": "string"
    },
    {
      "key": "session",
      "value": "= LEAVE BLANK =",
      "type": "string"
    },
    {
      "key": "ADOM",
      "value": "FMG ADOM",
      "type": "string"
    },
    {
      "key": "TEMPLATE_NAME",
      "value": "IPSec Template Name",
      "type": "string"
    },
    {
      "key": "TUNNEL_NAME",
      "value": "IPSec Tunnel Name - example: HUB1-VPN1",
      "type": "string"
    },
    {
      "key": "INTERFACE",
      "value": "FGT Outgoing Interface - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "LOCAL_ID",
      "value": "Local ID - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "LOCAL_GW_IP",
      "value": "Local GW's external interface IP - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "REMOTE_GW_IP",
      "value": "Remote GW IP - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "PSKSECRET",
      "value": "PSK for authentication",
      "type": "string"
    },
    {
      "key": "TUNNEL_INTERFACE_IP",
      "value": "Tunnel Interface Setup - IP - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "TUNNEL_REMOTE_IP",
      "value": "Tunnel Interface Setup - Remote IP - Metavariable can be used $(abc)",
      "type": "string"
    },
    {
      "key": "DEVICE",
      "value": "FortiGate Device Name - to assing the template",
      "type": "string"
    },
    {
      "key": "VDOM",
      "value": "FortiGate VDOM - to assing the template",
      "type": "string"
    },
    {
      "key": "templateResponse",
      "value": "= LEAVE BLANK ="
    }
  ]
}
